import { test, expect } from '@playwright/test';
import getName          from '../../../tools/playwright-helper/getname.js';
import { opendir }      from 'node:fs/promises';
import { join }         from 'node:path';

const ROOT            = '/src';
const IMPORT_LIB      = ROOT + '/lib/gsvg.script.js';
const IMPORT_TEMPLATE = ROOT + '/plugins/template.engine.script.js';
const IMPORT_PLUGIN   = ROOT + '/plugins/load.script.js';
const URL             = '/test/plugins/load/cases/';
const FOLDER          = './test/plugins/load/cases/';

const results = {
  case01 : `<svg viewBox="0 0 100 100" id="svg" style="width: 100px; height: 100px"> <g> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"> <path d="M464 32H48C21.492 32 0 53.49 0 80V432C0 458.51 21.492 480 48 480H464C490.508 480 512 458.51 512 432V80C512 53.49 490.508 32 464 32ZM48 464C30.355 464 16 449.645 16 432V380.688L122.344 274.344C125.469 271.219 130.531 271.219 133.656 274.344L212.688 353.375L102.062 464H48ZM496 432C496 449.645 481.645 464 464 464H124.688L378.344 210.344C381.469 207.219 386.531 207.219 389.656 210.344L496 316.688V432ZM496 294.062L400.969 199.031C391.594 189.687 376.406 189.687 367.031 199.031L224 342.062L144.969 263.031C135.594 253.688 120.406 253.688 111.031 263.031L16 358.062V80C16 62.355 30.355 48 48 48H464C481.645 48 496 62.355 496 80V294.062ZM128 104C97.07 104 72 129.072 72 160S97.07 216 128 216S184 190.928 184 160S158.93 104 128 104ZM128 200C105.945 200 88 182.055 88 160C88 137.943 105.945 120 128 120S168 137.943 168 160C168 182.055 150.055 200 128 200Z"></path> </svg> </g> </svg>`,
  case02 : `<svg viewBox="0 0 100 100" id="svg" style="width: 100px; height: 100px"> <g> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"> <path d="M464 32H48C21.492 32 0 53.49 0 80V432C0 458.51 21.492 480 48 480H464C490.508 480 512 458.51 512 432V80C512 53.49 490.508 32 464 32ZM48 464C30.355 464 16 449.645 16 432V380.688L122.344 274.344C125.469 271.219 130.531 271.219 133.656 274.344L212.688 353.375L102.062 464H48ZM496 432C496 449.645 481.645 464 464 464H124.688L378.344 210.344C381.469 207.219 386.531 207.219 389.656 210.344L496 316.688V432ZM496 294.062L400.969 199.031C391.594 189.687 376.406 189.687 367.031 199.031L224 342.062L144.969 263.031C135.594 253.688 120.406 253.688 111.031 263.031L16 358.062V80C16 62.355 30.355 48 48 48H464C481.645 48 496 62.355 496 80V294.062ZM128 104C97.07 104 72 129.072 72 160S97.07 216 128 216S184 190.928 184 160S158.93 104 128 104ZM128 200C105.945 200 88 182.055 88 160C88 137.943 105.945 120 128 120S168 137.943 168 160C168 182.055 150.055 200 128 200Z"></path> </svg> </g> </svg>`,
  case03 : `<svg viewBox="0 0 100 100" id="svg" style="width: 100px; height: 100px"> <g> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="50" height="50"> <path d="M464 32H48C21.492 32 0 53.49 0 80V432C0 458.51 21.492 480 48 480H464C490.508 480 512 458.51 512 432V80C512 53.49 490.508 32 464 32ZM48 464C30.355 464 16 449.645 16 432V380.688L122.344 274.344C125.469 271.219 130.531 271.219 133.656 274.344L212.688 353.375L102.062 464H48ZM496 432C496 449.645 481.645 464 464 464H124.688L378.344 210.344C381.469 207.219 386.531 207.219 389.656 210.344L496 316.688V432ZM496 294.062L400.969 199.031C391.594 189.687 376.406 189.687 367.031 199.031L224 342.062L144.969 263.031C135.594 253.688 120.406 253.688 111.031 263.031L16 358.062V80C16 62.355 30.355 48 48 48H464C481.645 48 496 62.355 496 80V294.062ZM128 104C97.07 104 72 129.072 72 160S97.07 216 128 216S184 190.928 184 160S158.93 104 128 104ZM128 200C105.945 200 88 182.055 88 160C88 137.943 105.945 120 128 120S168 137.943 168 160C168 182.055 150.055 200 128 200Z"></path> </svg> </g> </svg>`,
  case04 : `<svg viewBox="0 0 500 50" id="svg" style="width: 500px; height: 100px" "=""> <g> <g transform="translate(0,0)"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="50" height="50"> <path d="M464 32H48C21.492 32 0 53.49 0 80V432C0 458.51 21.492 480 48 480H464C490.508 480 512 458.51 512 432V80C512 53.49 490.508 32 464 32ZM48 464C30.355 464 16 449.645 16 432V380.688L122.344 274.344C125.469 271.219 130.531 271.219 133.656 274.344L212.688 353.375L102.062 464H48ZM496 432C496 449.645 481.645 464 464 464H124.688L378.344 210.344C381.469 207.219 386.531 207.219 389.656 210.344L496 316.688V432ZM496 294.062L400.969 199.031C391.594 189.687 376.406 189.687 367.031 199.031L224 342.062L144.969 263.031C135.594 253.688 120.406 253.688 111.031 263.031L16 358.062V80C16 62.355 30.355 48 48 48H464C481.645 48 496 62.355 496 80V294.062ZM128 104C97.07 104 72 129.072 72 160S97.07 216 128 216S184 190.928 184 160S158.93 104 128 104ZM128 200C105.945 200 88 182.055 88 160C88 137.943 105.945 120 128 120S168 137.943 168 160C168 182.055 150.055 200 128 200Z"></path> </svg> </g> </g> <g> <g transform="translate(50,0)"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="50" height="50"> <path d="M464 32H48C21.492 32 0 53.49 0 80V432C0 458.51 21.492 480 48 480H464C490.508 480 512 458.51 512 432V80C512 53.49 490.508 32 464 32ZM48 464C30.355 464 16 449.645 16 432V380.688L122.344 274.344C125.469 271.219 130.531 271.219 133.656 274.344L212.688 353.375L102.062 464H48ZM496 432C496 449.645 481.645 464 464 464H124.688L378.344 210.344C381.469 207.219 386.531 207.219 389.656 210.344L496 316.688V432ZM496 294.062L400.969 199.031C391.594 189.687 376.406 189.687 367.031 199.031L224 342.062L144.969 263.031C135.594 253.688 120.406 253.688 111.031 263.031L16 358.062V80C16 62.355 30.355 48 48 48H464C481.645 48 496 62.355 496 80V294.062ZM128 104C97.07 104 72 129.072 72 160S97.07 216 128 216S184 190.928 184 160S158.93 104 128 104ZM128 200C105.945 200 88 182.055 88 160C88 137.943 105.945 120 128 120S168 137.943 168 160C168 182.055 150.055 200 128 200Z"></path> </svg> </g> </g> <g> <g transform="translate(100,0)"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="50" height="50"> <path d="M464 32H48C21.492 32 0 53.49 0 80V432C0 458.51 21.492 480 48 480H464C490.508 480 512 458.51 512 432V80C512 53.49 490.508 32 464 32ZM48 464C30.355 464 16 449.645 16 432V380.688L122.344 274.344C125.469 271.219 130.531 271.219 133.656 274.344L212.688 353.375L102.062 464H48ZM496 432C496 449.645 481.645 464 464 464H124.688L378.344 210.344C381.469 207.219 386.531 207.219 389.656 210.344L496 316.688V432ZM496 294.062L400.969 199.031C391.594 189.687 376.406 189.687 367.031 199.031L224 342.062L144.969 263.031C135.594 253.688 120.406 253.688 111.031 263.031L16 358.062V80C16 62.355 30.355 48 48 48H464C481.645 48 496 62.355 496 80V294.062ZM128 104C97.07 104 72 129.072 72 160S97.07 216 128 216S184 190.928 184 160S158.93 104 128 104ZM128 200C105.945 200 88 182.055 88 160C88 137.943 105.945 120 128 120S168 137.943 168 160C168 182.055 150.055 200 128 200Z"></path> </svg> </g> </g> <g> <g transform="translate(150,0)"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="50" height="50"> <path d="M464 32H48C21.492 32 0 53.49 0 80V432C0 458.51 21.492 480 48 480H464C490.508 480 512 458.51 512 432V80C512 53.49 490.508 32 464 32ZM48 464C30.355 464 16 449.645 16 432V380.688L122.344 274.344C125.469 271.219 130.531 271.219 133.656 274.344L212.688 353.375L102.062 464H48ZM496 432C496 449.645 481.645 464 464 464H124.688L378.344 210.344C381.469 207.219 386.531 207.219 389.656 210.344L496 316.688V432ZM496 294.062L400.969 199.031C391.594 189.687 376.406 189.687 367.031 199.031L224 342.062L144.969 263.031C135.594 253.688 120.406 253.688 111.031 263.031L16 358.062V80C16 62.355 30.355 48 48 48H464C481.645 48 496 62.355 496 80V294.062ZM128 104C97.07 104 72 129.072 72 160S97.07 216 128 216S184 190.928 184 160S158.93 104 128 104ZM128 200C105.945 200 88 182.055 88 160C88 137.943 105.945 120 128 120S168 137.943 168 160C168 182.055 150.055 200 128 200Z"></path> </svg> </g> </g> <g> <g transform="translate(200,0)"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="50" height="50"> <path d="M464 32H48C21.492 32 0 53.49 0 80V432C0 458.51 21.492 480 48 480H464C490.508 480 512 458.51 512 432V80C512 53.49 490.508 32 464 32ZM48 464C30.355 464 16 449.645 16 432V380.688L122.344 274.344C125.469 271.219 130.531 271.219 133.656 274.344L212.688 353.375L102.062 464H48ZM496 432C496 449.645 481.645 464 464 464H124.688L378.344 210.344C381.469 207.219 386.531 207.219 389.656 210.344L496 316.688V432ZM496 294.062L400.969 199.031C391.594 189.687 376.406 189.687 367.031 199.031L224 342.062L144.969 263.031C135.594 253.688 120.406 253.688 111.031 263.031L16 358.062V80C16 62.355 30.355 48 48 48H464C481.645 48 496 62.355 496 80V294.062ZM128 104C97.07 104 72 129.072 72 160S97.07 216 128 216S184 190.928 184 160S158.93 104 128 104ZM128 200C105.945 200 88 182.055 88 160C88 137.943 105.945 120 128 120S168 137.943 168 160C168 182.055 150.055 200 128 200Z"></path> </svg> </g> </g> <g> <g transform="translate(250,0)"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="50" height="50"> <path d="M464 32H48C21.492 32 0 53.49 0 80V432C0 458.51 21.492 480 48 480H464C490.508 480 512 458.51 512 432V80C512 53.49 490.508 32 464 32ZM48 464C30.355 464 16 449.645 16 432V380.688L122.344 274.344C125.469 271.219 130.531 271.219 133.656 274.344L212.688 353.375L102.062 464H48ZM496 432C496 449.645 481.645 464 464 464H124.688L378.344 210.344C381.469 207.219 386.531 207.219 389.656 210.344L496 316.688V432ZM496 294.062L400.969 199.031C391.594 189.687 376.406 189.687 367.031 199.031L224 342.062L144.969 263.031C135.594 253.688 120.406 253.688 111.031 263.031L16 358.062V80C16 62.355 30.355 48 48 48H464C481.645 48 496 62.355 496 80V294.062ZM128 104C97.07 104 72 129.072 72 160S97.07 216 128 216S184 190.928 184 160S158.93 104 128 104ZM128 200C105.945 200 88 182.055 88 160C88 137.943 105.945 120 128 120S168 137.943 168 160C168 182.055 150.055 200 128 200Z"></path> </svg> </g> </g> <g> <g transform="translate(300,0)"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="50" height="50"> <path d="M464 32H48C21.492 32 0 53.49 0 80V432C0 458.51 21.492 480 48 480H464C490.508 480 512 458.51 512 432V80C512 53.49 490.508 32 464 32ZM48 464C30.355 464 16 449.645 16 432V380.688L122.344 274.344C125.469 271.219 130.531 271.219 133.656 274.344L212.688 353.375L102.062 464H48ZM496 432C496 449.645 481.645 464 464 464H124.688L378.344 210.344C381.469 207.219 386.531 207.219 389.656 210.344L496 316.688V432ZM496 294.062L400.969 199.031C391.594 189.687 376.406 189.687 367.031 199.031L224 342.062L144.969 263.031C135.594 253.688 120.406 253.688 111.031 263.031L16 358.062V80C16 62.355 30.355 48 48 48H464C481.645 48 496 62.355 496 80V294.062ZM128 104C97.07 104 72 129.072 72 160S97.07 216 128 216S184 190.928 184 160S158.93 104 128 104ZM128 200C105.945 200 88 182.055 88 160C88 137.943 105.945 120 128 120S168 137.943 168 160C168 182.055 150.055 200 128 200Z"></path> </svg> </g> </g> <g> <g transform="translate(350,0)"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="50" height="50"> <path d="M464 32H48C21.492 32 0 53.49 0 80V432C0 458.51 21.492 480 48 480H464C490.508 480 512 458.51 512 432V80C512 53.49 490.508 32 464 32ZM48 464C30.355 464 16 449.645 16 432V380.688L122.344 274.344C125.469 271.219 130.531 271.219 133.656 274.344L212.688 353.375L102.062 464H48ZM496 432C496 449.645 481.645 464 464 464H124.688L378.344 210.344C381.469 207.219 386.531 207.219 389.656 210.344L496 316.688V432ZM496 294.062L400.969 199.031C391.594 189.687 376.406 189.687 367.031 199.031L224 342.062L144.969 263.031C135.594 253.688 120.406 253.688 111.031 263.031L16 358.062V80C16 62.355 30.355 48 48 48H464C481.645 48 496 62.355 496 80V294.062ZM128 104C97.07 104 72 129.072 72 160S97.07 216 128 216S184 190.928 184 160S158.93 104 128 104ZM128 200C105.945 200 88 182.055 88 160C88 137.943 105.945 120 128 120S168 137.943 168 160C168 182.055 150.055 200 128 200Z"></path> </svg> </g> </g> <g> <g transform="translate(400,0)"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="50" height="50"> <path d="M464 32H48C21.492 32 0 53.49 0 80V432C0 458.51 21.492 480 48 480H464C490.508 480 512 458.51 512 432V80C512 53.49 490.508 32 464 32ZM48 464C30.355 464 16 449.645 16 432V380.688L122.344 274.344C125.469 271.219 130.531 271.219 133.656 274.344L212.688 353.375L102.062 464H48ZM496 432C496 449.645 481.645 464 464 464H124.688L378.344 210.344C381.469 207.219 386.531 207.219 389.656 210.344L496 316.688V432ZM496 294.062L400.969 199.031C391.594 189.687 376.406 189.687 367.031 199.031L224 342.062L144.969 263.031C135.594 253.688 120.406 253.688 111.031 263.031L16 358.062V80C16 62.355 30.355 48 48 48H464C481.645 48 496 62.355 496 80V294.062ZM128 104C97.07 104 72 129.072 72 160S97.07 216 128 216S184 190.928 184 160S158.93 104 128 104ZM128 200C105.945 200 88 182.055 88 160C88 137.943 105.945 120 128 120S168 137.943 168 160C168 182.055 150.055 200 128 200Z"></path> </svg> </g> </g> <g> <g transform="translate(450,0)"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="50" height="50"> <path d="M464 32H48C21.492 32 0 53.49 0 80V432C0 458.51 21.492 480 48 480H464C490.508 480 512 458.51 512 432V80C512 53.49 490.508 32 464 32ZM48 464C30.355 464 16 449.645 16 432V380.688L122.344 274.344C125.469 271.219 130.531 271.219 133.656 274.344L212.688 353.375L102.062 464H48ZM496 432C496 449.645 481.645 464 464 464H124.688L378.344 210.344C381.469 207.219 386.531 207.219 389.656 210.344L496 316.688V432ZM496 294.062L400.969 199.031C391.594 189.687 376.406 189.687 367.031 199.031L224 342.062L144.969 263.031C135.594 253.688 120.406 253.688 111.031 263.031L16 358.062V80C16 62.355 30.355 48 48 48H464C481.645 48 496 62.355 496 80V294.062ZM128 104C97.07 104 72 129.072 72 160S97.07 216 128 216S184 190.928 184 160S158.93 104 128 104ZM128 200C105.945 200 88 182.055 88 160C88 137.943 105.945 120 128 120S168 137.943 168 160C168 182.055 150.055 200 128 200Z"></path> </svg> </g> </g> </svg>`,
  case05 : `<svg viewBox="0 0 500 50" id="svg" style="width: 500px; height: 100px"> <defs> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="50" height="50" id="image"> <path d="M464 32H48C21.492 32 0 53.49 0 80V432C0 458.51 21.492 480 48 480H464C490.508 480 512 458.51 512 432V80C512 53.49 490.508 32 464 32ZM48 464C30.355 464 16 449.645 16 432V380.688L122.344 274.344C125.469 271.219 130.531 271.219 133.656 274.344L212.688 353.375L102.062 464H48ZM496 432C496 449.645 481.645 464 464 464H124.688L378.344 210.344C381.469 207.219 386.531 207.219 389.656 210.344L496 316.688V432ZM496 294.062L400.969 199.031C391.594 189.687 376.406 189.687 367.031 199.031L224 342.062L144.969 263.031C135.594 253.688 120.406 253.688 111.031 263.031L16 358.062V80C16 62.355 30.355 48 48 48H464C481.645 48 496 62.355 496 80V294.062ZM128 104C97.07 104 72 129.072 72 160S97.07 216 128 216S184 190.928 184 160S158.93 104 128 104ZM128 200C105.945 200 88 182.055 88 160C88 137.943 105.945 120 128 120S168 137.943 168 160C168 182.055 150.055 200 128 200Z"></path> </svg> </defs> <g> <use href="#image" transform="translate(0,0)"></use> </g> <g> <use href="#image" transform="translate(50,0)"></use> </g> <g> <use href="#image" transform="translate(100,0)"></use> </g> <g> <use href="#image" transform="translate(150,0)"></use> </g> <g> <use href="#image" transform="translate(200,0)"></use> </g> <g> <use href="#image" transform="translate(250,0)"></use> </g> <g> <use href="#image" transform="translate(300,0)"></use> </g> <g> <use href="#image" transform="translate(350,0)"></use> </g> <g> <use href="#image" transform="translate(400,0)"></use> </g> <g> <use href="#image" transform="translate(450,0)"></use> </g> </svg>`,
}

const dir = await opendir(FOLDER);
for await (const dirent of dir) {

  const file = dirent.name;
  const code = file.replace('.js', '');
  const name = await getName(join(process.cwd(), FOLDER, file));

  test.describe(name, () => {

    test.beforeEach(async ({page}) => {
      await page.goto(`/load.html?case=${ URL }${ dirent.name }&imp=${ IMPORT_LIB }&imp=${ IMPORT_TEMPLATE }&imp=${ IMPORT_PLUGIN }`);
    });

    test('compare source code result', async ({page}) => {
      const result = page.locator('#result');
      await expect(result).toHaveText(results[code]);
    });

    test('compare image', async ({page}) => {
      const show = page.locator('svg#svg');
      await expect(show).toHaveScreenshot()
    });

  });

}
